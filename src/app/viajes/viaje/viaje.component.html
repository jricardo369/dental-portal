<app-workspace-nav>
    <app-viajes-nav></app-viajes-nav>
</app-workspace-nav>
<div class='workspace'>
    <div class='main'>

        <!-- MENU DE VIAJE -->
        <div class='menu'>

            <button class='iigwo' (click)='cancelar()' style="background: none;margin-right: 24px;margin-left: -12px;">
                <mat-icon svgIcon="arrow-back"></mat-icon>
            </button>

            <label class='home'>{{titulo}}</label>

            <button class='iigwo' (click)='agregarComprobante()'
                *ngIf="editando && (solicitud.estatus == '3' || solicitud.estatus == '6' || solicitud.estatus == '9' || solicitud.estatus == '12')">
                <mat-icon svgIcon="add-box"></mat-icon>
                <label>Agregar comprobante</label>
            </button>

            <button class='iigwo' (click)='solicitarAutorizacion()'
                *ngIf="editando && (solicitud.estatus == '1' || solicitud.estatus == '4')">
                <!-- [disabled]='!viaje.comprobantes || viaje.comprobantes.length == 0'>  -->
                <mat-icon svgIcon="airplane"></mat-icon>
                <label>Solicitar aprobación</label>
            </button>

            <button class='iigwo' (click)='solicitarAutorizacionDeComprobacion()'
                *ngIf="editando && (solicitud.estatus == '3' || solicitud.estatus == '4' || solicitud.estatus == '6' || solicitud.estatus == '9' || solicitud.estatus == '12') && solicitud.comprobantes.length">
                <!-- [disabled]='!viaje.comprobantes || viaje.comprobantes.length == 0'>  -->
                <mat-icon svgIcon="airplane"></mat-icon>
                <label>Solicitar aprobación de comprobacion</label>
            </button>
            
            <!-- SOLO DUEÑO -->
            <button class='iigwo' (click)='eliminar()'
            *ngIf="editando && (solicitud.estatus == '1' || solicitud.estatus == '4')">
                <mat-icon svgIcon="delete"></mat-icon>
                <label>Eliminar</label>
            </button>
            
            <!-- ADVERTENCIAS -->
            <div class="dropdown" *ngIf='solicitud && solicitud.comprobantes && solicitud.comprobantes.length && solicitud.comprobantes.length > 0 && (solicitud.estatus !== "14" && solicitud.estatus !== "15")'>
                <button class='iigwo'>
                    <mat-icon svgIcon="alert"></mat-icon>
                    <label i18n="@@Refrescar">Advertencias<span class="badge">{{contadorAlertas}}</span></label>
                </button>
                <div class="dropdown-content" style="right: 0;">
                    <div *ngFor='let a of alertas' class="alert {{a.tipo}}">
                        <strong>{{a.titulo}}</strong><p>{{a.mensaje}}</p>
                    </div>
                </div>
            </div>
            
            <!-- TODOS MENOS NUEVO -->
            <button class='iigwo' (click)='actualizarViaje()'
                *ngIf='editando && solicitud.estatus !== "15"'>
                <mat-icon svgIcon="refresh"></mat-icon>
                <label i18n="@@Refrescar">Refrescar</label>
            </button>

            <!-- MAS -->
            <div class="dropdown more-menu" *ngIf="!creando">
                <button class='iigwo'>
                    <mat-icon svgIcon="more-vert"></mat-icon>
                    <label i18n="@@Refrescar">Mas</label>
                </button>
                <div class="dropdown-content more-menu-content">
                    <!-- DESCARGAR COMPROBANTES ZIP-->
                    <button class='iigwo' (click)='descargar(solicitud.numeroSolicitud, "Solicitud-" + solicitud.numeroSolicitud, "zip")' 
                        *ngIf='solicitud && solicitud.comprobantes && solicitud.comprobantes.length > 0'>
                        <mat-icon svgIcon="file-download"></mat-icon>
                        <label>Comprobantes ZIP</label>
                    </button>
                    <br>
                    <!-- DESCARGAR FACTURA PDF-->
                    <button class='iigwo' (click)='descargaFactura()'>
                        <mat-icon svgIcon="print"></mat-icon>
                        <label>Mostrar PDF</label>
                    </button>
                </div>
            </div>
            
            

        </div>

        <div class='content'>

            <div style="display:flex; flex-flow: row">

                <!-- CABECERA DEL VIAJE -->
                <div style="min-width:320px;margin-right:24px;margin-bottom: 10px;">

                    <div class="iigwo-input" *ngIf='editando'>
                        <label>Número de solicitud</label>
                        <input [(ngModel)]="solicitud.numeroSolicitud" readOnly>
                    </div>

                    <div class="iigwo-input">
                        <label>Estatus</label>
                        <!-- <input [(ngModel)]="solicitud.estatusDescripcion" readOnly> -->
                        <span class="badge-status" 
                            [ngClass]="{status_color_1: solicitud.estatus=='1',
                                        status_color_2: solicitud.estatus=='2',
                                        status_color_3: solicitud.estatus=='3',
                                        status_color_4: solicitud.estatus=='4',
                                        status_color_5: solicitud.estatus=='5',
                                        status_color_6: solicitud.estatus=='6',
                                        status_color_7: solicitud.estatus=='7',
                                        status_color_8: solicitud.estatus=='8',
                                        status_color_9: solicitud.estatus=='9',
                                        status_color_10: solicitud.estatus=='10',
                                        status_color_11: solicitud.estatus=='11',
                                        status_color_12: solicitud.estatus=='12',
                                        status_color_13: solicitud.estatus=='13',
                                        status_color_14: solicitud.estatus=='14',
                                        status_color_15: solicitud.estatus=='15'}"
                                    >
                            {{solicitud.estatusDescripcion}}
                        </span>
                    </div>

                    <div class="iigwo-input">
                        <label>Fecha inicio</label>
                        <input [ngModel]="solicitud.fechaInicio | date:'yyyy-MM-dd':'':'en'"
                            (ngModelChange)='solicitud.fechaInicio = $event' type="date"
                            [readOnly]='!ediandoCamposDeCabecera'>
                    </div>

                    <div class="iigwo-input">
                        <label>Fecha fin</label>
                        <input [ngModel]="solicitud.fechaFin | date:'yyyy-MM-dd':'':'en'"
                            (ngModelChange)='solicitud.fechaFin = $event' type="date"
                            [readOnly]='!ediandoCamposDeCabecera'>
                    </div>

                    <div class="iigwo-input">
                        <label>Motivo</label>
                        <input [(ngModel)]="solicitud.motivo" [readOnly]='!ediandoCamposDeCabecera' maxlength="150">
                    </div>

                    <div class="iigwo-input">
                        <label>Empresa</label>
                        <input [ngModel]="solicitud.grupo.nombre" readOnly> <!-- Empresa -->
                    </div>

                    <div class="iigwo-input">
                        <label>Departamento</label>
                        <input [ngModel]="solicitud.departamento.descripcion" readOnly>
                    </div>

                    <div class="iigwo-input">
                        <label>Concepto de timbrado</label>
                        <input [(ngModel)]="solicitud.concepto" readOnly>
                    </div>

                    <div class="iigwo-input">
                        <div class="wrapper">
                            <label>Monto<span [hidden]='!ediandoCamposDeCabecera'>{{formatoMonto}}</span></label>
                        </div>
                        
                        <div class="currency">
                            <input type="text" [ngModel]="!ediandoCamposDeCabecera ? (solicitud.totalAnticipo | currency : 'MXN' : 'symbol' : undefined : 'es-Mx') : solicitud.totalAnticipo"
                                (ngModelChange)="solicitud.totalAnticipo = $event;currentPattern()" [readOnly]='!ediandoCamposDeCabecera'
                                (keypress)="utilService.validateInput($event)">
                            <span [hidden]='!ediandoCamposDeCabecera'>$</span>
                        </div>
                    </div>

                    <div class="iigwo-input">
                        <label>Observaciones</label>
                        <textarea [(ngModel)]="solicitud.observaciones" [readOnly]='!ediandoCamposDeCabecera' placeholder="Sin observaciones"></textarea>
                    </div>

                    <!-- BOTONES CABECERA DE NUEVO VIAJE -->
                    <div *ngIf="creando">
                        <button class='iigwo' (click)='cancelar()'>
                            <label i18n="@@Cancelar">Cancelar</label>
                        </button>
                        <button class='accent iigwo' (click)='crear()' [disabled]="!validarCamposRequeridos()">
                            <label>Crear nueva solicitud</label>
                        </button>
                    </div>

                    <!-- BOTONES CABECERA DE VIAJE EXISTENTE -->
                    <div *ngIf="editando && (solicitud.estatus == '1' || solicitud.estatus == '4')">
                        <button class='iigwo primary' *ngIf='!ediandoCamposDeCabecera'
                            (click)='ediandoCamposDeCabecera=true;currentPattern()'>
                            <label>Editar campos de cabecera</label>
                        </button>
                        <button class='iigwo' *ngIf='ediandoCamposDeCabecera'
                            (click)='ediandoCamposDeCabecera=false;this.actualizarViaje();formatoMonto=""'>
                            <label i18n="@@Cancelar">Cancelar</label>
                        </button>
                        <button class='accent iigwo' *ngIf='ediandoCamposDeCabecera' (click)='guardar()' [disabled]="!validarCamposRequeridos()">
                            <label>Guardar cambios de cabecera</label>
                        </button>
                    </div>

                </div>

                <!-- PANEL DERECHA -->
                <div style="
                    flex-flow: column;
                    display: flex;
                    overflow: auto;
                    margin-bottom: 10px;
                ">

                    <!-- TEXTO AYUDA (CREANDO) -->
                    <div *ngIf='creando'>
                        <h4 style="margin: 0 0 12px 0">Llena los campos</h4>
                        <p style="margin-top: -6px; margin-bottom: 18px; font-size: 13px;">
                            Llene los campos de la cabecera y al terminar presione
                            <b>Crear nueva solicitud</b>. Una vez creada la solicitud podrá solicitar su aprobación.
                        </p>
                    </div>

                    <!-- TEXTO AYUDA (S) -->
                    <div *ngIf="editando && solicitud && solicitud.estatus == '1'">
                        <h4 style="margin: 0 0 12px 0">Solicitud creada</h4>
                        <p style="margin-top: -6px; margin-bottom: 18px; font-size: 13px;">
                            Revise que los datos de la solicitud sean correctos, en caso contrario presione
                            <b>editar campos de cabecera</b>. Cuando haya revisado la información presione el botón <b>solicitar
                                aprobación</b>.
                        </p>
                    </div>

                    <!-- TEXTO AYUDA (EDITANDO) -->
                    <div *ngIf="editando && solicitud && (solicitud.estatus == '3' || solicitud.estatus == '6' || solicitud.estatus == '9' || solicitud.estatus == '12')">
                        <h4 style="margin: 0 0 12px 0"
                            *ngIf='editando && solicitud.comprobantes && solicitud.comprobantes.length > 1'>
                            {{solicitud.comprobantes.length}} comprobantes cargados</h4>
                        <h4 style="margin: 0 0 12px 0"
                            *ngIf='editando && solicitud.comprobantes && solicitud.comprobantes.length == 1'>
                            Un comprobante cargado</h4>
                        <h4 style="margin: 0 0 12px 0"
                            *ngIf='editando && (!solicitud.comprobantes || solicitud.comprobantes.length == 0)'>
                            Cargue sus comprobantes</h4>
                        <p style="margin-top: -6px; margin-bottom: 18px; font-size: 13px;" *ngIf='editando'>
                            Presione el botón <b>agregar comprobante</b> en la barra de herramientas de arriba para
                            agregar
                            comprobantes a su solicitud.
                        </p>
                    </div>

                    <!-- TEXTO AYUDA (EDITAR) -->
                    <p style="margin-top: 6px; margin-bottom: 18px; font-size: 13px;"
                        *ngIf="editando && solicitud.comprobantes && solicitud.comprobantes.length && (solicitud.estatus == '3' || solicitud.estatus == '6' || solicitud.estatus == '9' || solicitud.estatus == '12')">
                        Cuando haya cargado todos sus comprobantes presione el botón <b>solicitar
                            aprobación</b>.
                    </p>

                    <!-- TEXTO AYUDA (EDITANDO UN VIAJE POR AUTORIZAR) -->
                    <div *ngIf="editando && solicitud.estatus == '2'">
                        <h4 style="margin: 0 0 12px 0">
                            Espere a que el aprobador resuelva el estado de la solicitud</h4>
                        <p style="margin-top: -6px; margin-bottom: 18px; font-size: 13px;">
                            La solicitud está en proceso de ser aprobada. Es responsabilidad del aprobador de la solicitud de
                            viáticos aprobar o rechazar la solicitud.
                        </p>
                    </div>

                    <!-- TEXTO AYUDA (EDITANDO UN VIAJE POR AUTORIZAR) -->
                    <div *ngIf="editando && solicitud.estatus == '4'">
                        <h4 style="margin: 0 0 12px 0">
                            El aprobador rechazó la solicitud</h4>
                        <p style="margin-top: -6px; margin-bottom: 18px; font-size: 13px;">
                            La solicitud fue rechazada. Para saber el motivo del rechazo revise la bitacora de eventos, 
                            para acceder a la bitacora de eventos presione <b>mostrar bitacora</b>. 
                            Cuando haya coregido la información indicada presione el botón <b>solicitar aprobación</b>.
                        </p>
                    </div>

                    <!-- TEXTO AYUDA (Estatus: Comprobación pendiente contador) -->
                    <div *ngIf="editando && (solicitud.estatus == '5' || solicitud.estatus == '8' || solicitud.estatus == '11')">
                        <h4 style="margin: 0 0 12px 0">
                            Espere a que el aprobador resuelva el estado de la comprobación de la solicitud</h4>
                        <p style="margin-top: -6px; margin-bottom: 18px; font-size: 13px;">
                            La comrpobacion de la solicitud está en proceso de ser aprobada. Es responsabilidad del aprobador de la comprobación 
                            de la solicitud de viáticos aprobar o rechazar la comprobación.
                        </p>
                    </div>

                    <!-- VISTA DE TABLA -->
                    <div class="iigwo-search-space" style="
                            overflow-y: auto;
                            border-top: solid 1px rgba(0,0,0,0.1);"
                        *ngIf='editando && solicitud.comprobantes && solicitud.comprobantes.length'>
                        <table>
                            <tr>
                                <!-- <th class=''></th> -->
                                <th class=''>Fecha</th>
                                <th class='' *ngIf='mostrarCamposOcultos'>RFC</th>
                                <th class=''>Número de factura</th>
                                <th class='number' *ngIf='mostrarCamposOcultos'>IVA</th>
                                <th class='number' *ngIf='mostrarCamposOcultos'>ISR</th>
                                <th class='number' *ngIf='mostrarCamposOcultos'>IEPS</th>
                                <th class='number'>Impuestos</th>
                                <th class='number'>Subtotal</th>
                                <th class='number'>Total</th>
                                <th class='number'>Propina</th>
                                <th class='' *ngIf='mostrarCamposOcultos'>Codigo Cuenta Contable</th>
                                <th class=''>Cuenta Contable</th>
                                <th class='' *ngIf='mostrarCamposOcultos'>Observaciones</th>
                                <th class='number' *ngIf='cerrado'>No aplica</th> <!-- descuentos -->
                                <th class='' *ngIf='cerrado'>No descontar</th> <!-- descuentos -->
                                <th class=''>PDF</th>
                                <th class=''>XML</th>
                            </tr>

                            <tbody *ngFor='let e of solicitud.comprobantes'>

                                <tr class="renglon">
                                    <!-- <td class='accent'><a routerLink='comprobantes/{{e.idComprobanteViatico}}'>Comprobante
                                            {{e.idComprobanteViatico}}</a></td> -->
                                    <td class='accent'><a routerLink='comprobantes/{{e.idComprobanteViatico}}'>{{e.fecha | date:'dd/MM/yyyy'}}</a></td>
                                    <td class='accent' *ngIf='mostrarCamposOcultos'>
                                        <a routerLink='comprobantes/{{e.idComprobanteViatico}}'>{{e.rfc}}</a>
                                        <p *ngIf='e.rfc === null'>No aplica</p>
                                    </td>
                                    <td class='accent'>
                                        <a routerLink='comprobantes/{{e.idComprobanteViatico}}'>{{e.numeroFactura}}</a>
                                        <p *ngIf='e.numeroFactura === null'>No aplica</p>
                                    </td>
                                    <td class='number accent' *ngIf='mostrarCamposOcultos'>
                                        {{e.iva | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}
                                        <p class='number' *ngIf='e.iva === null'>{{0 | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</p>
                                    </td>
                                    <td class='number accent' *ngIf='mostrarCamposOcultos'>
                                        {{e.isr | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}
                                        <p class='number' *ngIf='e.isr === null'>{{0 | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</p>
                                    </td>
                                    <td class='number accent' *ngIf='mostrarCamposOcultos'>
                                        {{e.ieps | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}
                                        <p class='number' *ngIf='e.ieps === null'>{{0 | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</p>
                                    </td>
                                    <td class='number accent'>{{e.impuesto | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='number accent'>{{e.subTotal | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='number accent'>{{e.total | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='number accent'>{{e.propina | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='accent' *ngIf='mostrarCamposOcultos'>{{e.subCuenta.codigo}}</td>
                                    <td class='accent'>{{e.subCuenta.descripcion}}</td>
                                    <td class='accent' *ngIf='mostrarCamposOcultos'>{{e.observaciones}}</td>
                                    <td class='number accent' *ngIf='cerrado'>{{(e.noAplica !== null ? e.noAplica : 0) | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td> <!-- descuentos -->
                                    <td class='accent' style="text-align: center;" *ngIf='cerrado'>
                                        <div class="iigwo-input" style="margin: 0;">
                                            <input type="checkbox"
                                                style="width: 17px;height: 17px;display: inline-block;margin: 0"
                                                [checked]='e.aprobacionNoAplica'
                                                disabled>
                                        </div>
                                    </td> <!-- descuentos -->
                                    <td class=''>
                                        <a (click)='descargar(e.idComprobanteViatico, e.rutaPdf, "pdf")' *ngIf='e.rutaPdf.length > 0'>
                                            <mat-icon svgIcon="file-download"></mat-icon></a>
                                        <p *ngIf='e.rutaPdf.length === 0'>S/PDF</p>
                                    </td>
                                    <td class=''>
                                        <a (click)='descargar(e.idComprobanteViatico, e.rutaXml, "xml")' *ngIf='e.rutaXml.length > 0'>
                                            <mat-icon svgIcon="file-download"></mat-icon></a>
                                        <p *ngIf='e.rutaXml.length === 0'>S/XML</p>
                                    </td>
                                </tr>

                            </tbody>

                            <tr class="" style="font-family:bold;">
                                <td class='' *ngIf='mostrarCamposOcultos'></td>
                                <td class='accent'>Total</td>
                                <td class='accent'>MXN</td>
                                <td class='number accent' *ngIf='mostrarCamposOcultos'>{{totalgv.iva | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent' *ngIf='mostrarCamposOcultos'>{{totalgv.isr | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent' *ngIf='mostrarCamposOcultos'>{{totalgv.ieps | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.impuesto | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.subTotal | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.total | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.propina | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='' *ngIf='mostrarCamposOcultos'></td>
                                <td class=''></td>
                                <td class='' *ngIf='mostrarCamposOcultos'></td>
                                <td class='' *ngIf='cerrado'></td>
                                <td class='' *ngIf='cerrado'></td>
                                <td class=''></td>
                                <td class=''></td>
                            </tr>

                        </table>
                    </div>
                    <p style="margin-top: 12px; margin-bottom: 0px; font-size: 13px;" *ngIf='editando && solicitud.comprobantes && solicitud.comprobantes.length'>

                        <span *ngIf="!mostrarCamposOcultos" i18n="@@cajachi.singlesol.mostrarBitacora0">Si desea mostrar todas las columnas
                            en la tabla haga clic en 
                        </span>
                        <span *ngIf="!mostrarCamposOcultos" (click)="mostrarCamposOcultos=true" class="link"
                        i18n="@@cajachi.singlesol.mostrarBitacora">mostrar campos ocultos</span>
                    
                        <span *ngIf="mostrarCamposOcultos" (click)="mostrarCamposOcultos=false" class="link"
                        i18n="@@cajachi.singlesol.ocultarBitacora">Ocultar  campos ocultos</span>
                    </p>

                </div>
            </div>
            
            <!-- BITACORA DE EVENTOS-->
            <div style="display:flex; flex-flow: row;" *ngIf="!creando">
                <app-bitacora [numeroSolicitud]="solicitud.numeroSolicitud"></app-bitacora>
            </div>
        </div>

        <!--Cargando-->
        <div class='iigwo-loading' *ngIf="loading">
            <mat-spinner></mat-spinner>
        </div>

    </div>
</div>