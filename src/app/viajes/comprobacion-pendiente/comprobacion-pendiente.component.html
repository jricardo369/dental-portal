<app-workspace-nav>
    <app-viajes-nav></app-viajes-nav>
</app-workspace-nav>
<div class='workspace'>
    <div class='main'>

        <!-- MENU DE VIAJE -->
        <div class='menu' *ngIf='!comprobantesSeleccionados.length'>

            <button class='iigwo' (click)='cancelar()' style="background: none;margin-right: 24px;margin-left: -12px;">
                <mat-icon svgIcon="arrow-back"></mat-icon>
            </button>

            <label class='home'>{{titulo}}</label>

            <button class='iigwo' (click)='aprobarSolicitud()' 
                *ngIf="(solicitud.estatus == '5' || solicitud.estatus == '8' || solicitud.estatus == '11') && esAprobador">
                <mat-icon svgIcon="done"></mat-icon>
                <label>Aprobar comprobación</label>
            </button>

            <button class='iigwo' (click)="rechazarSolicitud()"
            *ngIf="(solicitud.estatus == '5' || solicitud.estatus == '8' || solicitud.estatus == '11') && esAprobador">
                <mat-icon svgIcon="close"></mat-icon>
                <label>Rechazar comprobación</label>
            </button>

            <button class='iigwo' (click)='voBoSolicitud()' 
                *ngIf="esDirector && !esAprobador && !voboDirector">
                <mat-icon svgIcon="done-all"></mat-icon>
                <label>VoBo. de la Solicitud</label>
            </button>

            <!-- TODOS MENOS NUEVO -->
            <button class='iigwo' (click)='actualizarViaje()'
                *ngIf='editando && solicitud.estatus !== "15"'>
                <mat-icon svgIcon="refresh"></mat-icon>
                <label i18n="@@Refrescar">Refrescar</label>
            </button>

            <!-- ADVERTENCIAS -->
            <div class="dropdown" *ngIf='solicitud && solicitud.comprobantes && solicitud.comprobantes.length && solicitud.comprobantes.length > 0 && (solicitud.estatus !== "14" && solicitud.estatus !== "15")'>
                <button class='iigwo'>
                    <mat-icon svgIcon="alert"></mat-icon>
                    <label i18n="@@Refrescar">Advertencias<span class="badge">{{contadorAlertas}}</span></label>
                </button>
                <div class="dropdown-content" style="right: 0;">
                    <div *ngFor='let a of alertas' class="alert {{a.tipo}}">
                        <strong>{{a.titulo}}</strong><p>{{a.mensaje}}</p>
                    </div>
                </div>
            </div>

            <!-- MAS -->
            <div class="dropdown more-menu">
                <button class='iigwo'>
                    <mat-icon svgIcon="more-vert"></mat-icon>
                    <label i18n="@@Refrescar">Mas</label>
                </button>
                <div class="dropdown-content more-menu-content">
                    <!-- DESCARGAR COMPROBANTES ZIP-->
                    <button class='iigwo' (click)='descargar(solicitud.numeroSolicitud, "Solicitud-" + solicitud.numeroSolicitud, "zip")' *ngIf='solicitud && solicitud.comprobantes && solicitud.comprobantes.length > 0'>
                        <mat-icon svgIcon="file-download"></mat-icon>
                        <label>Comprobantes ZIP</label>
                    </button>
                    <br>
                    <!-- DESCARGAR FACTURA PDF-->
                    <button class='iigwo' (click)='descargaFactura()'>
                        <mat-icon svgIcon="print"></mat-icon>
                        <label>Mostrar PDF</label>
                    </button>
                    <br>
                    <!-- VER POLIZA -->
                    <button class='iigwo' (click)='poliza()' *ngIf='(solicitud.comprobantes && solicitud.comprobantes.length > 0) && esPrestador'>
                        <mat-icon svgIcon="assignment"></mat-icon>
                        <label>Ver poliza</label>
                    </button>
                </div>
            </div>
        </div>

        <!-- MENU DE COMPROBANTES SELECCIONADOS -->
        <!-- <div class='alternative menu' *ngIf='comprobantesSeleccionados.length'>

            <button class='iigwo' (click)='limpiarSeleccionDeComprobantes()'
                style="background: none;margin-right: 24px;margin-left: -12px;">
                <mat-icon svgIcon="close"></mat-icon>
            </button>

            <label
                class='home'>{{comprobantesSeleccionados.length == 1 ? 'Comprobante ' +
                comprobantesSeleccionados[0].idComprobanteViatico : comprobantesSeleccionados.length + ' comprobantes'}}</label>

            !-- BOTONES DE APROBACION DE COMPROBANTES --

            <button class='iigwo' (click)='aprobarComprobantesSeleccionados()' *ngIf='comprobantesSeleccionados.length && solicitud.comprobantes.length && ((comprobantesSeleccionados.length + noComprobantesAprobados) !== solicitud.comprobantes.length)'>
                <mat-icon svgIcon="done" *ngIf='comprobantesSeleccionados.length == 1'></mat-icon>
                <mat-icon svgIcon="done-all" *ngIf='comprobantesSeleccionados.length > 1'></mat-icon>
                <label>{{comprobantesSeleccionados.length == 1 ? 'Aprobar comprobante' : 'Aprobar comprobantes'}}</label>
            </button>

            <button class='iigwo' (click)='aprobarSolicitud()' *ngIf="comprobantesSeleccionados.length && solicitud.comprobantes.length && ((comprobantesSeleccionados.length + noComprobantesAprobados) == solicitud.comprobantes.length)">
                <mat-icon svgIcon="done"></mat-icon>
                <label>Aprobar comprobación</label>
            </button>

        </div> -->

        <div class='content'>

            <div style="display:flex; flex-flow: row">

                <!-- CABECERA DEL VIAJE -->
                <div style="min-width:320px;margin-right:24px;margin-bottom: 10px;">

                    <div class="iigwo-input" *ngIf='editando'>
                        <label>Número de solicitud</label>
                        <input [ngModel]="solicitud.numeroSolicitud" readOnly>
                    </div>

                    <div class="iigwo-input" *ngIf='editando'>
                        <label>Empleado</label>
                        <input [ngModel]="solicitud.nombreCompletoUsuario" readOnly>
                    </div>

                    <div class="iigwo-input">
                        <label>Fecha inicio</label>
                        <input [ngModel]="solicitud.fechaInicio | date:'yyyy-MM-dd':'':'en'"
                            type="date"
                            readOnly>
                    </div>

                    <div class="iigwo-input">
                        <label>Fecha fin</label>
                        <input [ngModel]="solicitud.fechaFin | date:'yyyy-MM-dd':'':'en'"
                            type="date"
                            readOnly>
                    </div>

                    <div class="iigwo-input">
                        <label>Motivo</label>
                        <input [ngModel]="solicitud.motivo" readOnly>
                    </div>

                    <div class="iigwo-input">
                        <label>Empresa</label>
                        <input [ngModel]="solicitud.grupo.nombre" readOnly> <!-- Empresa -->
                    </div>

                    <div class="iigwo-input">
                        <label>Departamento</label>
                        <input [ngModel]="solicitud.departamento.descripcion" readOnly>
                    </div>

                    <div class="iigwo-input">
                        <label>Concepto de timbrado</label>
                        <input [ngModel]="solicitud.concepto" readOnly>
                    </div>

                    <div class="iigwo-input">
                        <div class="wrapper">
                            <label>Monto solicitado</label>
                        </div>

                        <div class="currency">
                            <input type="text" [ngModel]="solicitud.totalAnticipo | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'"
                                readOnly>
                        </div>
                    </div>

                    <div class="iigwo-input">
                        <div class="wrapper">
                            <label>Monto comprobado</label>
                        </div>

                        <div class="currency">
                            <input type="text" [ngModel]="solicitud.totalComprobado | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'"
                                readOnly>
                        </div>
                    </div>

                    <div class="iigwo-input">
                        <label>Observaciones</label>
                        <textarea [ngModel]="solicitud.observaciones" readOnly  placeholder="Sin observaciones"></textarea>
                    </div>

                </div>

                <!-- PANEL DERECHA -->
                <div style="
                    flex-flow: column;
                    display: flex;
                    overflow: auto;
                    margin-bottom: 10px;
                ">

                    <!-- TEXTO AYUDA (autorizandoPorSociedad) -->
                    <div *ngIf='solicitud.comprobantes'>
                        <h4 style="margin: 0 0 12px 0">Revise los comprobantes</h4>
                        <p style="margin-top: -6px; margin-bottom: 18px; font-size: 13px;">
                            Revise cada uno de los comprobantes y apruebe o rechace la comprobación segun corresponda
                        </p>
                    </div>

                    <!-- VISTA DE TABLA -->
                    <div class="iigwo-search-space" style="
                            overflow-y: auto;
                            border-top: solid 1px rgba(0,0,0,0.1);"
                        *ngIf='editando && solicitud.comprobantes && solicitud.comprobantes.length'>
                        <table>
                            <tr>
                                <!-- <th class='' *ngIf="(solicitud.estatus == '5' || solicitud.estatus == '8' || solicitud.estatus == '11') && !esDirector"></th> -->
                                <th class=''>Estatus</th>
                                <th class=''>Fecha</th>
                                <th class='' *ngIf='mostrarCamposOcultos'>RFC</th>
                                <th class=''>Número de factura</th>
                                <!-- <th class='' i18n="@@Estatus">Estatus</th> -->
                                <th class='number' *ngIf='mostrarCamposOcultos'>IVA</th>
                                <th class='number' *ngIf='mostrarCamposOcultos'>ISR</th>
                                <th class='number' *ngIf='mostrarCamposOcultos'>IEPS</th>
                                <th class='number'>Impuestos</th>
                                <th class='number'>Subtotal</th>
                                <th class='number'>Total</th>
                                <th class='number'>Propina</th>
                                <th class='' *ngIf='mostrarCamposOcultos'>Codigo Cuenta Contable</th>
                                <th class=''>Cuenta Contable</th>
                                <th class='' *ngIf='mostrarCamposOcultos'>Observaciones</th>
                                <th class='number'>No aplica</th> <!-- descuentos -->
                                <th class=''>No descontar</th> <!-- descuentos -->
                            </tr>

                            <tbody *ngFor='let e of solicitud.comprobantes' 
                                [ngClass]="{selectedRow: e.seleccionado}">

                                <tr class="renglon">
                                    <!-- <td *ngIf="(solicitud.estatus == '5' || solicitud.estatus == '8' || solicitud.estatus == '11') && !esDirector">
                                        <button class="iigwo small" style="padding:0" style="margin: 0" *ngIf="e.estatusComprobante !== 'AUTORIZAR'"
                                            (click)="seleccionar(e)">
                                            <mat-icon [svgIcon]="e.seleccionado ? 'remove' : 'add'"></mat-icon>
                                        </button>
                                    </td> -->
                                    <td class='accent'><a routerLink='comprobantes/{{e.idComprobanteViatico}}'>{{e.estatusComprobante}}</a></td>
                                    <td class='accent'><a routerLink='comprobantes/{{e.idComprobanteViatico}}'>{{e.fecha | date:'dd/MM/yyyy'}}</a></td>
                                    <td class='accent' *ngIf='mostrarCamposOcultos'>
                                        <a routerLink='comprobantes/{{e.idComprobanteViatico}}'>{{e.rfc}}</a>
                                        <p *ngIf='e.rfc === null'>No aplica</p>
                                    </td>
                                    <td class='accent'>
                                        <a routerLink='comprobantes/{{e.idComprobanteViatico}}'>{{e.numeroFactura}}</a>
                                        <p *ngIf='e.numeroFactura === null'>No aplica</p>
                                    </td>
                                    <td class='number accent' *ngIf='mostrarCamposOcultos'>
                                        {{e.iva | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}
                                        <p class='number' *ngIf='e.iva === null'>{{0 | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</p>
                                    </td>
                                    <td class='number accent' *ngIf='mostrarCamposOcultos'>
                                        {{e.isr | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}
                                        <p class='number' *ngIf='e.isr === null'>{{0 | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</p>
                                    </td>
                                    <td class='number accent' *ngIf='mostrarCamposOcultos'>
                                        {{e.ieps | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}
                                        <p class='number' *ngIf='e.ieps === null'>{{0 | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</p>
                                    </td>
                                    <td class='number accent'>{{e.impuesto | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='number accent'>{{e.subTotal | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='number accent'>{{e.total | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='number accent'>{{e.propina | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                    <td class='accent' *ngIf='mostrarCamposOcultos'>{{e.subCuenta.codigo}}</td>
                                    <td class='accent'>{{e.subCuenta.descripcion}}</td>
                                    <td class='accent' *ngIf='mostrarCamposOcultos'>{{e.observaciones}}</td>
                                    <td class='number accent'>{{(e.noAplica !== null ? e.noAplica : 0) | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td> <!-- descuentos -->
                                    <td class='accent' style="text-align: center;">
                                        <div class="iigwo-input" style="margin: 0;">
                                            <input type="checkbox"
                                                style="width: 17px;height: 17px;display: inline-block;margin: 0"
                                                [checked]='e.aprobacionNoAplica'
                                                (change)='e.aprobacionNoAplica = eventoNoAplica(e)' 
                                                [disabled]='!(esContador || esAprobador) || e.noAplica == null || e.noAplica == 0'>
                                        </div>
                                    </td> <!-- descuentos -->
                                </tr>

                            </tbody>

                            <tr class="" style="font-family:bold;">
                                <!-- <td class='' *ngIf="(solicitud.estatus == '5' || solicitud.estatus == '8' || solicitud.estatus == '11') && !esDirector"></td> -->
                                <td class=''></td>
                                <td class='' *ngIf='mostrarCamposOcultos'></td>
                                <td class='accent'>Total</td>
                                <td class='accent'>MXN</td>
                                <td class='number accent' *ngIf='mostrarCamposOcultos'>{{totalgv.iva | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent' *ngIf='mostrarCamposOcultos'>{{totalgv.isr | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent' *ngIf='mostrarCamposOcultos'>{{totalgv.ieps | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.impuesto | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.subTotal | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.total | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='number accent'>{{totalgv.propina | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td>
                                <td class='' *ngIf='mostrarCamposOcultos'></td>
                                <td class=''></td>
                                <td class='' *ngIf='mostrarCamposOcultos'></td>
                                <td class='number accent'>{{totalgv.noAplica | currency : 'MXN' : 'symbol' : undefined : 'es-Mx'}}</td> <!-- descuentos -->
                                <td class=''></td> <!-- descuentos -->
                            </tr>

                        </table>
                    </div>

                    <p style="margin-top: 12px; margin-bottom: 0px; font-size: 13px;" *ngIf='editando && solicitud.comprobantes && solicitud.comprobantes.length'>

                        <span *ngIf="!mostrarCamposOcultos" i18n="@@cajachi.singlesol.mostrarBitacora0">Si desea mostrar todas las columnas
                            en la tabla haga clic en 
                        </span>
                        <span *ngIf="!mostrarCamposOcultos" (click)="mostrarCamposOcultos=true" class="link"
                        i18n="@@cajachi.singlesol.mostrarBitacora">mostrar campos ocultos</span>

                        <span *ngIf="mostrarCamposOcultos" (click)="mostrarCamposOcultos=false" class="link"
                        i18n="@@cajachi.singlesol.ocultarBitacora">Ocultar  campos ocultos</span>
                    </p>
                </div>

            </div>

            <!-- BITACORA DE EVENTOS-->
            <div style="display:flex; flex-flow: row;">
                <app-bitacora [numeroSolicitud]="solicitud.numeroSolicitud"></app-bitacora>
            </div>
        </div>

        <!--Cargando-->
        <div class='iigwo-loading' *ngIf="loading">
            <mat-spinner></mat-spinner>
        </div>
    </div>
</div>